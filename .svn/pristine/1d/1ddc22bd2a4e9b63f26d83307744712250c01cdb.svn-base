import {Injectable, Inject} from "@angular/core";
import {Router} from "@angular/router";
import {APP_CONFIG, IAppConfig} from "../../../environments/environment";
import {Logger} from "../logger/logger";
import {JwtHelper} from "angular2-jwt";
import {Observable} from "rxjs/Observable";
import "rxjs/add/operator/catch";
import "rxjs/add/observable/throw";
import {isNullOrUndefined} from "util";
import {LocalStorageService} from "angular-2-local-storage";
import {UserDataProviderService} from "./userdata-provider.service";
import {Http} from "@angular/http";
import {UserLogin} from "../../models/userLogin";

@Injectable()
export class LoginService extends UserDataProviderService{

    private dafterLogin: string;
    private dafterLogout: string;

    loginObservable: Observable<boolean>;
    userObservable: Observable<any>;
    router: Router;
    constructor(_router: Router, @Inject(APP_CONFIG) config: IAppConfig, logger: Logger,
                defaultHttp: Http, localStorageService: LocalStorageService,jwtHelper: JwtHelper) {
        super(config,logger,localStorageService,jwtHelper,defaultHttp);
        this.dafterLogin = config.defaultAfterLogin;
        this.dafterLogout = config.defaultAfterLogout;
        this.className = "LoginService";
        this.loginObservable = this.loginSubject.asObservable();
        this.userObservable = this.userSubject.asObservable();
        this.router = _router;
        this.initUserFromStorage();

    }

    public checkNredirect() {
        let isLoggedIn = this.getLoginState();
        if (isLoggedIn) {
            this.logger.debug(this.className, isLoggedIn);
            this.router.navigate([this.config.defaultAfterLogin]);
        }
    }

    public signUp(userData: any): Observable<any> {
        let cartId = this.localStorageService.get(this.config.cartToken);
        if (isNullOrUndefined(cartId)) {
            cartId = '';
        }
        //let userObservables = this.getUserObservable.concat(this.userLoggedInObservable);
        return this.defaultHttp.post(this.config.playAPIUrl+'/secure/user/login/signup', {
            "username": userData.email.trim().toLowerCase(),
            "email": userData.email,
            "password": userData.password.confirm_password
        },this.setHeader()).map(response => {
            if(!isNullOrUndefined(response)){
                let body = response.json();
                this.processToken(response,true);
                return body;
            }
            return response
        }).catch(error => {
            this.logger.debug(this.className, "Error Occured! :( " + error.error);
            return Observable.throw(error);
        });

    }

    public loginUser(userData: any): Observable<any> {
        this.logger.debug(this.className, userData);
        return this.defaultHttp.post(this.config.playAPIUrl+'/secure/user/login', {
            "username": userData.email.trim().toLowerCase(),
            "password": userData.password
        },this.setHeader()).map(response => {
            if(!isNullOrUndefined(response)){
                let body = response.json();
                this.processToken(response,true);
                return body;
            }
            return response
        }).catch(err => {
            return Observable.throw(err);
        });
    }



    public doesUserExists(username: string): Observable<any> {
        this.logger.debug(this.className, username);

        return this.defaultHttp.post(this.config.playAPIUrl+'/secure/user/checkUsernameInDB', {
            "username": username
        }, this.setHeader()).map(response => {
            if(!isNullOrUndefined(response)){
                let body = response.json()
                if(!isNullOrUndefined(body['doesUserExists'])){
                    return body['doesUserExists']
                }
            }
            return false
        }).catch(error => {
            this.logger.debug(this.className, "Error Occured! :( " + error.error);
            return Observable.throw(error);
        })
    }


    public logOutUser() {
        this.localStorageService.remove(this.config.authToken)
        this.clearDataProviders()
        this.router.navigate([this.config.defaultAfterLogout]);
    }

    public clearDataProviders(){
        this.initToken();
        this.initUserFromStorage();
    }

    public initUserFromStorage() {
        let token = this.localStorageService.get(this.config.authToken);
        this.logger.debug(this.className,"initUserFromStorage()",token);
        if (!isNullOrUndefined(token) && token!='null' && token!='undefined') {
            let user = this.jwtHelper.decodeToken(JSON.stringify(token));
            this.logger.debug(this.className, user);
            this.setUserSubjectState(user);
            if (user && user.username && !user.username.includes("Anonymous")) {
                this.setLoginSubjectState(true);
                this.processUserData()
            }else{
                this.setLoginSubjectState(false);
                this.setUserSubjectState(new  UserLogin);
            }
        }else{
            this.setLoginSubjectState(false);
            this.setUserSubjectState(new UserLogin);
        }
    }

    public getUserObject(): UserLogin {
        return this.userSubject.getValue();
    }

    public getLoginState(): boolean {
        return this.loginSubject.getValue();
    }


    public setLoginSubjectState(value: boolean) {
        this.loginSubject.next(value);
    }

    public setUserSubjectState(value: UserLogin) {
        this.userSubject.next(value);
    }
}
